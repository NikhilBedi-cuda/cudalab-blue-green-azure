---
- name: Wait 600 seconds for port 22 to become open on the host, don't start checking for 10 seconds
  wait_for:
    host: "{{ hostvars[inventory_hostname].ansible_host }}"
    search_regex: OpenSSH
    port: 22
    delay: 10
    timeout: 900
  connection: local

- name: updates a server
  apt: update_cache=yes

- name: upgrade a server
  apt: upgrade=dist

- name: Check if a reboot is required
  register: file
  stat: path=/var/run/reboot-required get_md5=no

- name: Reboot the server
  command: /sbin/reboot
  when: file.stat.exists == true

# This pause is mandatory, otherwise the existing control connection gets reused!
- pause: seconds=30

- name: Wait 600 seconds for port 22 to become open on the host, don't start checking for 10 seconds
  wait_for:
    host: "{{ hostvars[inventory_hostname].ansible_host }}"
    port: 22
    delay: 10
    timeout: 600
